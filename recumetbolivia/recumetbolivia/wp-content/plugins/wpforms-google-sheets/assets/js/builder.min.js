"use strict";WPForms.Admin.Builder.Providers.GoogleSheets=WPForms.Admin.Builder.Providers.GoogleSheets||function(e,p){const u={provider:"google-sheets",isReady:!1,$holder:null,$connections:null,Providers:{},templates:{config:["wpforms-google-sheets-builder-content-auth-error","wpforms-google-sheets-builder-content-conditionals","wpforms-google-sheets-builder-content-connection","wpforms-google-sheets-builder-content-connection-error","wpforms-google-sheets-builder-content-connection-conditionals","wpforms-google-sheets-builder-content-error","wpforms-google-sheets-builder-content-fields","wpforms-google-sheets-builder-content-sheet-select","wpforms-google-sheets-builder-content-lock","wpforms-google-sheets-builder-content-new-account-advanced-form"],providerTemplates:{},load:function(){u.templates.providerTemplates=WPForms.Admin.Builder.Templates,u.templates.providerTemplates.add(u.templates.config)},render:function(e,o={}){e="wpforms-"+u.provider+"-builder-content-"+e;const t=u.templates.providerTemplates.get(e);return t(o)}},cache:{providerCache:{},getConnection:function(e){e=u.cache.providerCache.getById(u.provider,"connections",e);return _.isObject(e)?e:null},getSpreadsheets:function(){var e=u.cache.providerCache.get(u.provider,"spreadsheets");return _.isEmpty(e)?null:e},getSheets:function(e){e=u.cache.providerCache.getById(u.provider,"sheets",e);return _.isObject(e)?e:null},addToSheets:function(e,o){u.cache.providerCache.addTo(u.provider,"sheets",e,o)},getColumns:function(e,o){e=u.cache.providerCache.getById(u.provider,"columns",e);return _.isObject(e)&&_.has(e,o)&&_.isObject(e[o])?e[o]:null}},init:function(){const t="settings";wpf.getQueryString("view")===t&&p("#wpforms-panel-"+t).on("WPForms.Admin.Builder.Providers.ready",u.ready),p(e).on("wpformsPanelSwitched",function(e,o){o===t&&u.ready()})},ready:function(){u.isReady||(u.Providers=WPForms.Admin.Builder.Providers,u.cache.providerCache=u.Providers.cache,u.$holder=u.Providers.getProviderHolder(u.provider),u.$connections=u.$holder.find(".wpforms-builder-provider-connections"),u.templates.load(),u.bindUIActions(),u.bindTriggers(),u.processInitial(),u.isReady=!0)},bindUIActions:function(){u.Providers.ui.account.registerAddHandler(u.provider,u.ui.account.add),p(e).on("click",".js-wpforms-google-sheets-setting-field-redirect-uri-copy",u.ui.account.copyUrlClick).on("click",".js-wpforms-google-sheets-change-mode",u.ui.account.switchToAdvancedMode).on("wpformsFieldUpdate",u.ui.customFields.mapSelectFields),p("#wpforms-builder").on("wpformsSaved",u.ui.connection.refreshConnections),u.$holder.on("click",".wpforms-alert .wpforms-btn",u.ui.account.reconnect).on("connectionCreate",u.ui.connection.create).on("connectionDelete",u.ui.connection.delete).on("change",".js-wpforms-builder-google-sheets-provider-connection-spreadsheet-id",u.ui.spreadsheetField.changeSpreadsheet).on("change",".js-wpforms-builder-google-sheets-provider-connection-sheet-id",u.ui.sheetField.changeSheet).on("change",".js-wpforms-builder-google-sheets-provider-connection-spreadsheet-id, .js-wpforms-builder-google-sheets-provider-connection-sheet-id",u.ui.docLink.changeFields).on("click",".js-wpforms-builder-google-sheets-provider-connection-fields-add",u.ui.customFields.addNewRow).on("change",".js-wpforms-builder-provider-connection-field-id",u.ui.customFields.changeFieldIdField).on("accountAddModal.onOpenBefore",u.ui.account.updatePopup)},bindTriggers:function(){u.$holder.on("connectionsDataLoaded",function(e,o){if(!_.isEmpty(o.connections))for(const t in o.connections)u.ui.connection.generate(o.connections[t])}),u.$holder.on("connectionGenerated",function(e,o){var t=u.ui.connection.getById(o.connection.id);const i=p(".js-wpforms-builder-google-sheets-provider-connection-spreadsheet-id",t);u.ui.connection.isNewConnection(o.connection)&&u.ui.connection.replaceConnectionIds(o.connection.id,t),new Choices(i.get(0),wpforms_builder_settings.choicesjs_config);t=u.cache.providerCache.get(u.provider,"non_editable_spreadsheets");Object.prototype.hasOwnProperty.call(o.connection,"spreadsheet_id")&&Object.values(t).includes(o.connection.spreadsheet_id)&&u.ui.connection.lock(o.connection)})},processInitial:function(){u.$holder.prepend(u.tmpl.commonsHTML()),u.ui.connection.dataLoad()},ui:{toggleFieldVisibility:function(e,o,t=!1){const i=e.find("select, input");if(o)return i.removeClass("wpforms-disabled").removeClass("wpforms-required"),void e.removeClass("wpforms-hidden");i.addClass("wpforms-disabled"),e.addClass("wpforms-hidden"),t&&i.addClass("wpforms-required")},spreadsheetField:{changeSpreadsheet:function(){const e=p(this);var o=e.val();const t=e.closest(".wpforms-builder-provider-connection"),i=p(".wpforms-builder-google-sheets-provider-sheet-id",t),n=i.find("select",t),r=p(".wpforms-builder-google-sheets-provider-sheet-name",t),s=p(".wpforms-builder-google-sheets-provider-spreadsheet-name",t);if(u.ui.connection.unlock(t),""===o||null===o)return u.ui.toggleFieldVisibility(s,!1),u.ui.toggleFieldVisibility(i,!1),u.ui.toggleFieldVisibility(r,!1),void n.val("");const d=s.find("input"),c=r.find("input");if("new"===o)return u.ui.toggleFieldVisibility(s,!0),u.ui.toggleFieldVisibility(i,!1,!0),u.ui.toggleFieldVisibility(r,!0),n.val("new").removeAttr("disabled").removeClass("wpforms-disabled").trigger("change"),d.val(""),void c.val("");var o=t.data("connection_id"),l=e.val(),a=u.cache.providerCache.get(u.provider,"non_editable_spreadsheets");if(Object.values(a).includes(l))return a=u.cache.getConnection(o),void u.ui.connection.generate(a);o=u.cache.getSheets(l);u.ui.toggleFieldVisibility(s,!1),u.ui.toggleFieldVisibility(i,!0,!0),u.ui.toggleFieldVisibility(r,!1),o?u.tmpl.sheetField(o,t):u.ui.spreadsheetField.requestData(t)},requestData:function(o){const t=p(".wpforms-builder-google-sheets-provider-spreadsheet-id select",o).val(),e=p(".wpforms-builder-google-sheets-provider-sheet-id",o),i=e.find("select");u.Providers.ajax.request(u.provider,{data:{task:"spreadsheet_data_get",spreadsheet_id:t}}).done(function(e){_.isEmpty(e.data.sheets)||(u.cache.addToSheets(t,e.data.sheets),u.tmpl.sheetField(e.data.sheets,o),i.val("").trigger("change"))})},nonEditableModal:function(){u.modal(wpforms_builder.google_sheets_non_editable_spreadsheets)}},sheetField:{changeSheet:function(){const e=p(this);var o=e.val(),t=e.closest(".wpforms-builder-provider-connection");const i=p(".wpforms-builder-google-sheets-provider-spreadsheet-id select",t);var n=p(".wpforms-builder-google-sheets-provider-sheet-name",t);u.ui.toggleFieldVisibility(n,"new"===o),i.val()&&u.ui.sheetField.requestData(t)},requestData:function(o){const e=p(".wpforms-builder-google-sheets-provider-spreadsheet-id select",o);var t=e.val();const i=p(".wpforms-builder-google-sheets-provider-sheet-id select",o);var n,r=i.val();const s=p(".wpforms-builder-google-sheets-provider-connection-fields",o);null!==r&&(n=u.ui.customFields.getValue(o),s.removeClass("wpforms-hidden"),u.Providers.ajax.request(u.provider,{data:{task:"sheet_data_get",spreadsheet_id:t,sheet_id:r,custom_fields:n}}).done(function(e){if(!_.isEmpty(e.data.columns)){let i=!1;u.tmpl.customFields(o,e.data.columns,e.data.custom_fields),s.find(".wpforms-builder-provider-connection-fields-table-row").each(function(){const e=p(this);if(0===p(this).index())return!0;const o=e.find(".wpforms-builder-provider-connection-field-name"),t=e.find(".wpforms-builder-provider-connection-field-id");return!o.val()&&t.val()?!(i=!0):void 0}),i&&u.modal(wpforms_builder.google_sheets_not_mapped_field_found)}}))}},customFields:{getValue:function(e){const o=p(".wpforms-builder-google-sheets-provider-connection-fields",e),i=[];return o.find("tr").each(function(){var e=p(this),o=p(".wpforms-builder-provider-connection-field-name",e).val();if(!o)return!0;var t=p(".wpforms-builder-provider-connection-field-id",e).val(),e=p(".wpforms-builder-provider-connection-field-value",e).val();i.push({name:o,field_id:t,value:e})}),i},addNewRow:function(e){e.preventDefault();e=p(this).closest(".wpforms-builder-provider-connection-fields-table");const o=p("tr",e).last().clone(!0);var t=p(".wpforms-builder-provider-connection-field-name",o),i=p(".wpforms-builder-provider-connection-field-id",o),n=p(".wpforms-builder-provider-connection-field-value",o),r=parseInt(/\[.+]\[.+]\[.+]\[(\d+)]/.exec(o.find(".wpforms-builder-provider-connection-field-name").attr("name"))[1],10)+1;const s=p(".wpforms-field-option-row",o);u.ui.customFields.replaceFieldIndex(t,r),u.ui.customFields.replaceFieldIndex(i,r),u.ui.customFields.replaceFieldIndex(n,r),p(".toggle-smart-tag-display",o).removeClass("wpforms-hidden"),s.addClass("wpforms-hidden"),s.prev().attr("colspan",2),p(".js-wpforms-builder-provider-connection-fields-delete",o).removeClass("wpforms-hidden"),p("tbody",e).append(o.get(0))},changeFieldIdField:function(){const e=p(this);var o=e.val(),t=e.closest(".wpforms-builder-provider-connection-fields-table-row");const i=e.closest(".wpforms-builder-provider-connection-fields-table-column"),n=p(".wpforms-field-option-row",t);if("custom"===o)return n.removeClass("wpforms-hidden"),void i.removeAttr("colspan");n.addClass("wpforms-hidden"),i.attr("colspan",2)},replaceFieldIndex:function(e,o){const t=e.closest("label");e.attr("name",e.attr("name").replace(/\[custom_fields]\[(\d+)]/g,"[custom_fields]["+o+"]")).attr("id",e.attr("id").replace(/\d+$/g,o)).removeAttr("disabled").val(""),t.attr("for",t.attr("for").replace(/\d+$/g,o))},mapSelectFields:function(e,t){p(".js-wpforms-builder-provider-connection-field-id").each(function(){const e=p(this);var o=e.find("option:selected").val();u.ui.customFields.updateSelectOptions(e,t),o&&e.find('option[value="'+o+'"]').prop("selected",!0),p("#wpforms-builder").trigger("wpformsFieldSelectMapped",[e])})},updateSelectOptions:function(e,o){var t,i,n=wpforms_builder.google_sheets_select_form_field;if(e.empty().append(p("<option>",{value:"",text:n})),o&&!p.isEmptyObject(o))for(const r in wpf.orders.fields)Object.prototype.hasOwnProperty.call(wpf.orders.fields,r)&&(o[t=wpf.orders.fields[r]]&&(i=u.ui.customFields.getFieldLabel(o[t],t),e.append(p("<option>",{value:o[t].id,text:i}))));e.append(p("<option>",{value:"custom",text:wpforms_builder.google_sheets_custom_value}))},getFieldLabel:function(e,o){return void 0!==e.label&&""!==e.label.toString().trim()?wpf.sanitizeHTML(e.label.toString().trim()):wpforms_builder.field+" #"+o}},account:{reconnect:function(e){e.preventDefault(),wpforms_builder.exit_url=p(this).attr("href"),WPFormsBuilder.formSave(!0)},add:function(e){if(!u.ui.account.isValidForm(e))return!1;const o=e.$content,t=o.find(".wpforms-google-sheets-auth-error");e=u.ui.account.getFormMode(o);const i={mode:e};"advanced"===e&&(i.client_id=u.ui.account.getFieldValueByName("client_id",o),i.client_secret=u.ui.account.getFieldValueByName("client_secret",o)),u.Providers.ajax.request(u.provider,{data:{task:"account_save",data:i}}).done(function(e){if(e.success)return p(".wpforms-builder-provider-connections-save-lock",u.$holder).val(1),wpforms_builder.exit_url=e.data,void WPFormsBuilder.formSave(!0);_.has(e,"data")&&t.html(e.data),t.show()})},isValidForm:function(e){e=e.$content;const o=p(".wpforms-google-sheets-auth-required-error",e);if("pro"===u.ui.account.getFormMode(e))return o.hide(),!0;var t=u.ui.account.getFieldValueByName("client_id",e),i=u.ui.account.getFieldValueByName("client_secret",e);const n=p('input[name="client_id"]',e),r=p('input[name="client_secret"]',e);return Boolean(t.length&&i.length)?(o.hide(),n.removeClass("wpforms-error"),r.removeClass("wpforms-error"),!0):(o.show(),n.addClass("wpforms-error"),r.addClass("wpforms-error"),!1)},getFormMode:function(e){return p('input[name="client_id"]',e).length?"advanced":"pro"},getFormContainer:function(e){return"advanced"===u.ui.account.getFormMode(e)?p(".wpforms-google-sheets-auth-custom",e):p(".wpforms-google-sheets-auth-pro",e)},getFieldValueByName:function(e,o){const t=p('[name="'+e+'"]',o);return t.length?t.val().toString().trim():""},copyUrlClick:function(){const e=p(this);var o=e.closest(".wpforms-google-sheets-setting-field-redirect-uri-row");const t="wpforms-google-sheets-setting-field-redirect-uri-copy-success",i=p(".wpforms-google-sheets-setting-field-redirect-uri-input",o);i.select(),navigator.clipboard.writeText(i.val()).then(function(){e.addClass(t),setTimeout(function(){e.removeClass(t)},500)})},switchToAdvancedMode:function(e){e.preventDefault(),p.alert({title:wpforms_builder.google_sheets_advanced_form_title,content:u.templates.render("new-account-advanced-form"),icon:"fa fa-info-circle",type:"blue",animation:"none",closeAnimation:"none",buttons:{confirm:{text:wpforms_builder.google_sheets_advanced_form_add_button,btnClass:"btn-confirm",keys:["enter"],action:function(){return u.$holder.trigger("accountAddModal.buttons.add.action.before",[this]),u.ui.account.add(this),!1}},cancel:{text:wpforms_builder.google_sheets_advanced_form_cancel_button}},onOpenBefore:function(){this.$jconfirmBg.removeClass("jconfirm-bg"),this.$body.addClass("wpforms-providers-account-add-modal"),u.$holder.trigger("accountAddModal.onOpenBefore",[this])}})},updatePopup:function(e,o){var t=o.$content,t=u.ui.account.getFormMode(t),i="google_sheets_"+t+"_form_footer";"pro"===t&&o.$$add.text(wpforms_builder.ok),o.$body.css("padding-bottom","63px").append('<div class="wpforms-google-sheets-auth-footer">'+wpforms_builder[i]+"</div>")},invalidAccountModal:function(e){u.modal(wpforms_builder.google_sheets_auth_failed);const o=u.Providers.getProviderHolder(u.provider),t=o.find(".wpforms-builder-provider-body"),i=o.find(".wpforms-builder-provider-connections-default"),n=o.find(".wpforms-builder-provider-title-add");t.prepend(u.templates.render("auth-error",{reauthUrl:e})),i.hide(),n.hide(),p(".wpforms-builder-provider-connections-save-lock",u.$holder).val(1)}},docLink:{changeFields:function(){var e=p(this).closest(".wpforms-builder-provider-connection");u.ui.docLink.update(e)},update:function(o){var t=p(".wpforms-builder-google-sheets-provider-spreadsheet-id select",o).val();const i=p(".wpforms-builder-google-sheets-provider-spreadsheet-id a",o);if(t&&"new"!==t){let e=p(".wpforms-builder-google-sheets-provider-sheet-id select",o).val();e="new"===e||null===e?0:e,i.attr("href",u.ui.docLink.getSpreadsheetURL(t,e)).removeClass("wpforms-hidden")}else i.addClass("wpforms-hidden")},getSpreadsheetURL:function(e,o){return"https://docs.google.com/spreadsheets/d/{spreadsheetId}/edit#gid={sheetId}".replace("{spreadsheetId}",e).replace("{sheetId}",o)}},connection:{getById:function(e){return u.$holder.find('.wpforms-builder-provider-connection[data-connection_id="'+e+'"]')},create:function(e,o){var t=(new Date).getTime().toString(16),o={id:t,name:o,isNew:!0};u.cache.providerCache.addTo(u.provider,"connections",t,o),u.ui.connection.generate(o)},delete:function(e,o){var t=u.Providers.getProviderHolder(u.provider);o.closest(t).length&&(t=o.data("connection_id"),_.isString(t)&&u.cache.providerCache.deleteFrom(u.provider,"connections",t))},generate:function(e){u.ui.connection.replace(e);var o=u.cache.getSheets(e.spreadsheet_id),t=u.cache.getColumns(e.spreadsheet_id,e.sheet_id),i=u.ui.connection.getById(e.id);if(u.tmpl.sheetField(o,i),void 0!==e.sheet_id&&""!==e.sheet_id){const n=p(".wpforms-builder-google-sheets-provider-sheet-id",i),r=p(".wpforms-builder-google-sheets-provider-connection-fields",i);n.find('option[value="'+e.sheet_id+'"]').prop("selected",!0),u.ui.docLink.update(i),u.tmpl.customFields(i,t,e.custom_fields),r.removeClass("wpforms-hidden")}u.$holder.trigger("connectionGenerated",[{connection:e}])},replace:function(e){var o=u.tmpl.conditional(e),t=u.cache.getSpreadsheets(),t=u.templates.render("connection",{connection:e,spreadsheets:t,conditional:o,provider:u.provider});u.ui.connection.getById(e.id).length?u.ui.connection.getById(e.id).replaceWith(t):u.$connections.prepend(t)},isNewConnection:function(e){return _.has(e,"isNew")&&e.isNew},dataLoad:function(){u.Providers.ajax.request(u.provider,{data:{task:"connections_get"}}).done(function(t){_.isEmpty(t.data.invalid_account)?t.success&&_.has(t.data,"connections")&&(p.each(["columns","conditionals","connections","non_editable_spreadsheets","sheets","spreadsheets"],function(e,o){u.cache.providerCache.set(u.provider,o,{}),_.has(t.data,o)&&!_.isEmpty(t.data[o])&&u.cache.providerCache.set(u.provider,o,jQuery.extend({},t.data[o]))}),_.isEmpty(t.data.non_editable_spreadsheets)||u.ui.spreadsheetField.nonEditableModal(),u.$holder.trigger("connectionsDataLoaded",[t.data])):u.ui.account.invalidAccountModal(t.data.invalid_account)})},refreshConnections:function(e,o){if(Object.prototype.hasOwnProperty.call(o,"google_sheets")){const t=o.google_sheets;if(_.isEmpty(t.invalid_account)){p.each(["columns","sheets","spreadsheets"],function(e,o){_.has(t,o)&&!_.isEmpty(t[o])&&u.cache.providerCache.set(u.provider,o,jQuery.extend(u.cache.providerCache.get(u.provider,o),t[o]))});for(const i in t.connections)u.ui.connection.generate(t.connections[i])}else u.ui.account.invalidAccountModal(t.invalid_account)}},replaceConnectionIds:function(o,e){e.find("input, textarea, select, label").each(function(){const e=p(this);e.attr("name")&&e.attr("name",e.attr("name").replace(/%connection_id%/gi,o)),e.attr("id")&&e.attr("id",e.attr("id").replace(/%connection_id%/gi,o)),e.attr("for")&&e.attr("for",e.attr("for").replace(/%connection_id%/gi,o)),e.attr("data-name")&&e.attr("data-name",e.attr("data-name").replace(/%connection_id%/gi,o))})},lock:function(e){const o=u.ui.connection.getById(e.id),t=p(".js-wpforms-builder-google-sheets-provider-connection-sheet-id",o),i=p(".wpforms-builder-google-sheets-provider-connection-fields .add,.wpforms-builder-google-sheets-provider-connection-fields .delete,.toggle-smart-tag-display,.wpforms-conditional-block .wpforms-conditional-rule-add,.wpforms-conditional-block .wpforms-conditional-rule-delete,.wpforms-conditional-block .wpforms-conditional-groups-add,.wpforms-conditional-block .wpforms-conditional-group:last h5",o),n=p(".wpforms-builder-provider-connection-block:eq(0)",o),r=p(".wpforms-builder-google-sheets-provider-spreadsheet-id select",o);var s=r.val();t.find("option").remove(),t.append(new Option(e.sheet_id,e.sheet_id,!0)),i.addClass("wpforms-hidden"),o.find("select, input").prop("disabled","disabled"),n.prepend(u.templates.render("connection-error",{email:wpforms_builder.google_sheets_email,spreadsheet_url:u.ui.docLink.getSpreadsheetURL(s,e.sheet_id)})),o.prepend('<input type="hidden" name="'+r.prop("name").replace("spreadsheet_id","__lock__")+'" value="1">')},unlock:function(e){var o=e.data("connection_id");const t=p(".wpforms-alert",e),i=p('[name="providers[google-sheets]['+o+'][__lock__]"]'),n=p(".wpforms-builder-provider-connection-fields-table-row:eq(0)",e),r=p(".wpforms-builder-google-sheets-provider-connection-fields .add,.wpforms-builder-google-sheets-provider-connection-fields .delete,.toggle-smart-tag-display,.wpforms-conditional-block .wpforms-conditional-rule-add,.wpforms-conditional-block .wpforms-conditional-rule-delete,.wpforms-conditional-block .wpforms-conditional-groups-add,.wpforms-conditional-block .wpforms-conditional-group:last h5",e);t.remove(),i.remove(),e.find("select, input").removeAttr("disabled","disabled"),n.find("select, input").prop("disabled","disabled"),r.removeClass("wpforms-hidden")}}},tmpl:{commonsHTML:function(){return u.templates.render("error")+u.templates.render("lock",{provider:u.provider})},sheetField:function(e,o){var t=p(".wpforms-builder-google-sheets-provider-spreadsheet-id select").val();const i=p(".wpforms-builder-google-sheets-provider-sheet-id .wpforms-builder-provider-connection-block-field",o);i.html(u.templates.render("sheet-select",{provider:u.provider,connection_id:o.data("connection_id"),fields:wpf.getFields(),sheets:e,spreadsheet_id:t}))},customFields:function(e,o,t){const i=p(".wpforms-builder-google-sheets-provider-connection-fields",e);i.html(u.templates.render("fields",{connection_id:e.data("connection_id"),fields:wpf.getFields(),provider:u.provider,columns:o,custom_fields:t})),wpf.initTooltips()},conditional:function(e){return _.has(e,"conditional")&&!u.ui.connection.isNewConnection(e)?e.conditional:u.templates.render("connection-conditionals")}},modal:function(e){p.alert({title:wpforms_builder.heads_up,content:e,icon:"fa fa-exclamation-circle",type:"orange",buttons:{confirm:{text:wpforms_builder.ok,btnClass:"btn-confirm",keys:["enter"]}}})}};return u}(document,(window,jQuery)),WPForms.Admin.Builder.Providers.GoogleSheets.init();